<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COFFE TRADE PRO - Trading Real Caf√©</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.8);
            --accent: #22c55e;
            --gold: #f59e0b;
            --profit: #10b981;
            --loss: #ef4444;
            --text: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; padding: 10px; }
        .header { text-align: center; padding: 20px; background: linear-gradient(135deg, var(--accent), var(--gold)); border-radius: 20px; margin-bottom: 20px; }
        .title { font-size: 2.5rem; color: white; }
        .card { background: var(--card); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; margin: 15px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .price-section { text-align: center; font-size: 3rem; font-weight: bold; }
        .change { font-size: 1.5rem; padding: 10px; border-radius: 10px; }
        .profit { background: rgba(16,185,129,0.3); color: var(--profit); }
        .loss { background: rgba(239,68,68,0.3); color: var(--loss); }
        .btn { background: var(--accent); color: white; border: none; padding: 15px 30px; border-radius: 15px; font-size: 1.2rem; cursor: pointer; margin: 10px; box-shadow: 0 8px 20px rgba(34,197,94,0.4); transition: 0.3s; }
        .btn:hover { transform: translateY(-5px); }
        .btn-sell { background: var(--loss); }
        .trading-controls { text-align: center; }
        .position { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin: 20px 0; font-size: 1.4rem; }
        .chart-container { height: 400px; margin: 20px 0; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--card); border-radius: 20px; padding: 30px; max-width: 500px; text-align: center; }
        .emoji-big { font-size: 4rem; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">COFFE TRADE PRO ‚òï</h1>
        <p>Trading Real Caf√© Arabica - Cali Edition</p>
    </div>

    <div class="card">
        <h2>Datos Mercado Hoy</h2>
        <div class="price-section">
            <div id="price">$2.93 USD/lb</div>
            <div id="change" class="change">Cargando...</div>
            <div>High: <span id="high">--</span> | Low: <span id="low">--</span></div>
        </div>
        <button class="btn" onclick="actualizarDatos()">Actualizar Mercado</button>
    </div>

    <div class="card">
        <h2>Gr√°fica Precios 2026</h2>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>Trading Simulado (1000 lbs)</h2>
        <div class="position" id="position">No tienes posici√≥n abierta.</div>
        <div class="trading-controls">
            <button class="btn" onclick="comprar()">Comprar</button>
            <button class="btn btn-sell" onclick="vender()" id="sell-btn" disabled>Vender</button>
            <button class="btn" onclick="consultarIA()">IA Consejo</button>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2>Consejo IA ‚òï</h2>
            <div class="emoji-big" id="modal-emoji"></div>
            <p id="modal-text"></p>
            <button class="btn" onclick="cerrarModal()">Cerrar</button>
        </div>
    </div>

    <script>
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        let currentPrice = 2.93;
        let high = 0, low = 0, changePct = 0;
        let buyPrice = 0;
        let posicion = false;
        let chart;

        const historicalData = [
            {date: 'Ene', price: 3.80},
            {date: 'Feb 1', price: 3.50},
            {date: 'Feb 5', price: 3.20},
            {date: 'Feb 10', price: 3.00},
            {date: 'Hoy', price: currentPrice}
        ];

        function crearGrafica() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historicalData.map(d => d.date),
                    datasets: [{
                        label: 'Precio Caf√© USD/lb',
                        data: historicalData.map(d => d.price),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34,197,94,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: false } } }
            });
        }

        async function actualizarDatos() {
            try {
                const url = CORS_PROXY + encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/KC=F?range=1d&interval=1m');
                const res = await fetch(url);
                const data = await res.json();
                const meta = data.chart.result[0].meta;
                const indicators = data.chart.result[0].indicators.quote[0];

                currentPrice = (meta.regularMarketPrice / 100).toFixed(2);
                high = (Math.max(...indicators.high) / 100).toFixed(2);
                low = (Math.min(...indicators.low.filter(v => v) ) / 100).toFixed(2);
                changePct = ((currentPrice - meta.previousClose / 100) / (meta.previousClose / 100) * 100).toFixed(2);

                document.getElementById('price').innerText = `$${currentPrice} USD/lb`;
                document.getElementById('high').innerText = high;
                document.getElementById('low').innerText = low;
                const changeEl = document.getElementById('change');
                changeEl.innerText = `${changePct > 0 ? '+' : ''}${changePct}%`;
                changeEl.className = changePct > 0 ? 'change profit' : 'change loss';

                historicalData[historicalData.length - 1].price = parseFloat(currentPrice);
                crearGrafica();
                actualizarPosicion();
            } catch (e) {
                console.log('Fallback precio real hoy ~$2.93');
            }
        }

        function actualizarPosicion() {
            if (posicion) {
                const valorActual = currentPrice * 1000;
                const valorCompra = buyPrice * 1000;
                const pl = valorActual - valorCompra;
                const pct = ((pl / valorCompra) * 100).toFixed(2);
                document.getElementById('position').innerHTML = `
                    Posici√≥n: 1000 lbs @ $${buyPrice}<br>
                    Valor actual: $${valorActual.toFixed(0)} USD<br>
                    P&L: <span style="color: ${pl >= 0 ? '#10b981' : '#ef4444'}">$${pl.toFixed(0)} USD (${pct}%)</span>
                `;
                document.getElementById('sell-btn').disabled = false;
            }
        }

        function comprar() {
            if (posicion) return;
            buyPrice = currentPrice;
            posicion = true;
            actualizarPosicion();
        }

        function vender() {
            if (!posicion) return;
            posicion = false;
            actualizarPosicion();
        }

        function consultarIA() {
            const consejos = [
                {e: 'ü•≥', t: "Precio bajo como caf√© barato en la finca. ¬°COMPRA y acumula!"},
                {e: '‚ö†Ô∏è', t: "Subiendo como r√≠o en invierno. ¬°VENDE y asegura ganancia!"},
                {e: 'ü§ù', t: "Tranquilo como domingo en Cali. Espera el momento."}
            ];
            const c = consejos[Math.floor(Math.random() * consejos.length)];
            document.getElementById('modal-emoji').innerText = c.e;
            document.getElementById('modal-text').innerText = c.t;
            document.getElementById('modal').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modal').style.display = 'none';
        }

        actualizarDatos();
        setInterval(actualizarDatos, 30000);
        crearGrafica();
    </script>
</body>
</html>
