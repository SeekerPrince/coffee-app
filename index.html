<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COFFE TRADE PRO - Simulador Inversión Café 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.85);
            --accent: #22c55e;
            --gold: #f59e0b;
            --profit: #10b981;
            --loss: #ef4444;
            --text: #e2e8f0;
            --text-light: #94a3b8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; padding: 10px; min-height: 100vh; }
        .header { text-align: center; padding: 30px; background: linear-gradient(135deg, var(--accent), var(--gold)); border-radius: 24px; margin-bottom: 20px; }
        .title { font-size: 3rem; color: white; font-weight: bold; }
        .subtitle { color: rgba(255,255,255,0.9); font-size: 1.3rem; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card); backdrop-filter: blur(12px); border-radius: 20px; padding: 25px; box-shadow: 0 12px 35px rgba(0,0,0,0.5); border: 1px solid rgba(34,197,94,0.2); }
        .price-big { font-size: 4.5rem; text-align: center; font-weight: 900; background: linear-gradient(135deg, var(--accent), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0; }
        .stat { font-size: 1.3rem; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px; }
        .change { padding: 12px; border-radius: 12px; font-weight: bold; text-align: center; }
        .profit { background: rgba(16,185,129,0.3); color: var(--profit); }
        .loss { background: rgba(239,68,68,0.3); color: var(--loss); }
        .btn { background: var(--accent); color: white; border: none; padding: 14px 28px; border-radius: 14px; font-size: 1.2rem; cursor: pointer; margin: 8px; box-shadow: 0 6px 18px rgba(34,197,94,0.4); transition: 0.3s; }
        .btn:hover { transform: translateY(-4px); }
        .btn-sell { background: var(--loss); box-shadow: 0 6px 18px rgba(239,68,68,0.4); }
        .trading-section { text-align: center; margin: 20px 0; }
        .input { padding: 12px; border-radius: 12px; border: none; width: 180px; margin: 10px; font-size: 1.1rem; }
        .select { padding: 12px; border-radius: 12px; border: none; margin: 10px; }
        .position-card { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 16px; margin: 20px 0; font-size: 1.4rem; line-height: 1.8; }
        .chart-container { height: 500px; margin: 30px 0; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 16px; }
        .simulator-result { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 16px; margin: 20px 0; font-size: 1.4rem; }
        .trades-history { max-height: 350px; overflow-y: auto; margin-top: 20px; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 15px; }
        .trade-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-content { background: var(--card); border-radius: 24px; padding: 40px; max-width: 650px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .emoji-big { font-size: 5.5rem; margin: 25px 0; }
        .options-sim { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 16px; margin: 20px 0; }
        @media (max-width: 768px) { .price-big { font-size: 3.2rem; } .title { font-size: 2.4rem; } .dashboard { grid-template-columns: 1fr; } .chart-container { height: 400px; } }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">COFFE TRADE PRO 2026 ☕</h1>
        <p class="subtitle">Simulador Completo Inversión Café Arabica con Fórmulas Black-Scholes (del video)</p>
    </div>

    <div class="dashboard">
        <div class="card">
            <h2>Precio Actual Mercado</h2>
            <div class="price-big" id="price">$2.93</div>
            <div class="stat-grid">
                <div class="stat">Cambio: <span id="change" class="change">Cargando...</span></div>
                <div class="stat">High: <span id="high">--</span></div>
                <div class="stat">Low: <span id="low">--</span></div>
                <div class="stat">Open: <span id="open">--</span></div>
                <div class="stat">Volumen: <span id="volume">--</span></div>
            </div>
            <button class="btn" onclick="actualizarDatos()">Actualizar Datos</button>
        </div>

        <div class="card">
            <h2>Simulador Histórico (Buy & Hold)</h2>
            <select id="start-date" class="select">
                <option value="0">Ene 2025 - $3.80</option>
                <option value="1">Abr 2025 - $3.55</option>
                <option value="2">Jul 2025 - $3.30</option>
                <option value="3">Oct 2025 - $3.15</option>
                <option value="4">Ene 2026 - $3.05</option>
                <option value="5">Feb 1 2026 - $3.00</option>
                <option value="6">Feb 5 2026 - $2.97</option>
                <option value="7">Feb 10 2026 - $2.94</option>
            </select>
            <input type="number" id="investment-amount" class="input" placeholder="Monto USD" value="10000">
            <button class="btn" onclick="simularInversion()">Simular</button>
            <div class="simulator-result" id="simulator-result">Elige fecha y monto para simular.</div>
        </div>
    </div>

    <div class="card">
        <h2>Gráfica Histórica Completa 2025-2026</h2>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>Trading Simulado en Tiempo Real (Futures)</h2>
        <div class="position-card" id="position">No tienes posición abierta. P&L total: $0 USD</div>
        <div class="trading-section">
            <input type="number" id="cantidad" class="input" placeholder="Cantidad lbs" value="1000">
            <button class="btn" onclick="comprar()">Comprar</button>
            <button class="btn btn-sell" onclick="vender()" id="sell-btn" disabled>Vender</button>
            <button class="btn" onclick="consultarIA()">Consejo IA ☕</button>
        </div>
        <div class="trades-history">
            <h3>Historial Trades</h3>
            <div id="trades-list">No hay trades.</div>
        </div>
    </div>

    <div class="card">
        <h2>Simulador de Opciones (Fórmula Black-Scholes del video)</h2>
        <div class="options-sim">
            <p>Precio actual café: <strong>$<span id="current-s">2.93</span> USD/lb</strong></p>
            <input type="number" id="strike" class="input" placeholder="Strike price USD/lb" value="3.00" step="0.01">
            <input type="number" id="time-days" class="input" placeholder="Días hasta vencimiento" value="30">
            <input type="number" id="volatility" class="input" placeholder="Volatilidad % (ej. 35)" value="35">
            <input type="number" id="risk-free" class="input" placeholder="Tasa libre riesgo % (ej. 4)" value="4">
            <button class="btn" onclick="calcularOpciones()">Calcular Precios Opciones</button>
            <div id="option-prices" style="margin: 20px 0; font-size: 1.3rem;"></div>
            <hr>
            <h3>Simular Payoff al Vencimiento</h3>
            <input type="number" id="expiration-price" class="input" placeholder="Precio al vencimiento USD/lb" value="3.10" step="0.01">
            <input type="number" id="option-cantidad" class="input" placeholder="Contratos (1 = 37,500 lbs)" value="1">
            <button class="btn" onclick="simularPayoff('call')">Simular Call</button>
            <button class="btn btn-sell" onclick="simularPayoff('put')">Simular Put</button>
            <div id="payoff-result" style="margin: 20px 0; font-size: 1.3rem;"></div>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-light);">Fórmula Black-Scholes del video "La Ecuación del Billón de Dólares": Precio opción = valor esperado con hedging dinámico y volatilidad.</p>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2>Consejo IA ☕</h2>
            <div class="emoji-big" id="modal-emoji"></div>
            <p id="modal-text" style="font-size: 1.3rem; line-height: 1.8;"></p>
            <button class="btn" onclick="cerrarModal()">Cerrar</button>
        </div>
    </div>

    <script>
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        let currentPrice = 2.93;
        let marketData = { high: 2.95, low: 2.91, change: -0.5, volume: 17960, open: 2.94 };
        let posicion = { abierta: false, cantidad: 0, precioCompra: 0 };
        let trades = [];
        let plTotal = 0;
        let chart;

        const historical = [
            {date: 'Ene 2025', price: 3.80},
            {date: 'Abr 2025', price: 3.55},
            {date: 'Jul 2025', price: 3.30},
            {date: 'Oct 2025', price: 3.15},
            {date: 'Ene 2026', price: 3.05},
            {date: 'Feb 1 2026', price: 3.00},
            {date: 'Feb 5 2026', price: 2.97},
            {date: 'Feb 10 2026', price: 2.94},
            {date: 'Hoy 11 Feb 2026', price: currentPrice}
        ];

        // Aproximación CDF normal para Black-Scholes
        function norm_cdf(z) {
            if (z > 6) return 1;
            if (z < -6) return 0;
            const b1 = 0.31938153, b2 = -0.356563782, b3 = 1.781477937, b4 = -1.821255978, b5 = 1.330274429;
            const p = 0.2316419, c = 0.39894228;
            const abs_z = Math.abs(z);
            const t = 1 / (1 + p * abs_z);
            let n = c * Math.exp(-z * z / 2) * t * (b1 + t*(b2 + t*(b3 + t*(b4 + t*b5))));
            return z >= 0 ? 1 - n : n;
        }

        function blackScholes(type, S, K, T, r, sigma) {
            if (T <= 0) return type === 'call' ? Math.max(S - K, 0) : Math.max(K - S, 0);
            const d1 = (Math.log(S / K) + (r + sigma * sigma / 2) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            if (type === 'call') {
                return S * norm_cdf(d1) - K * Math.exp(-r * T) * norm_cdf(d2);
            } else {
                return K * Math.exp(-r * T) * norm_cdf(-d2) - S * norm_cdf(-d1);
            }
        }

        function calcularOpciones() {
            const S = currentPrice;
            const K = parseFloat(document.getElementById('strike').value) || 3.00;
            const days = parseFloat(document.getElementById('time-days').value) || 30;
            const T = days / 365;
            const sigma = (parseFloat(document.getElementById('volatility').value) || 35) / 100;
            const r = (parseFloat(document.getElementById('risk-free').value) || 4) / 100;

            const callPrice = blackScholes('call', S, K, T, r, sigma).toFixed(4);
            const putPrice = blackScholes('put', S, K, T, r, sigma).toFixed(4);

            document.getElementById('option-prices').innerHTML = `
                <strong>Prima Call (derecho a comprar):</strong> $${callPrice} USD/lb<br>
                <strong>Prima Put (derecho a vender):</strong> $${putPrice} USD/lb<br>
                <small>(Multiplicador contrato real: 37,500 lbs - prima total = prima × 37,500)</small>
            `;
        }

        function simularPayoff(type) {
            const expirationPrice = parseFloat(document.getElementById('expiration-price').value) || currentPrice;
            const contratos = parseFloat(document.getElementById('option-cantidad').value) || 1;
            const multiplier = 37500; // Contrato real café opciones ICE

            const K = parseFloat(document.getElementById('strike').value) || 3.00;
            const days = parseFloat(document.getElementById('time-days').value) || 30;
            const T = days / 365;
            const sigma = (parseFloat(document.getElementById('volatility').value) || 35) / 100;
            const r = (parseFloat(document.getElementById('risk-free').value) || 4) / 100;

            const premium = type === 'call' ? blackScholes('call', currentPrice, K, T, r, sigma) : blackScholes('put', currentPrice, K, T, r, sigma);
            const payoffPerLb = type === 'call' ? Math.max(expirationPrice - K, 0) : Math.max(K - expirationPrice, 0);
            const netPerLb = payoffPerLb - premium;
            const netTotal = netPerLb * multiplier * contratos;

            const result = document.getElementById('payoff-result');
            result.innerHTML = `
                <strong>Simulación ${type.toUpperCase()} al vencimiento (precio $${expirationPrice}):</strong><br>
                Prima pagada: $${(premium * multiplier * contratos).toFixed(0)} USD<br>
                Payoff bruto: $${(payoffPerLb * multiplier * contratos).toFixed(0)} USD<br>
                Ganancia/Pérdida neta: <span style="color: ${netTotal >= 0 ? '#10b981' : '#ef4444'}">$${netTotal.toFixed(0)} USD</span><br>
                <small>Riesgo limitado a la prima (ventaja opciones vs futures)</small>
            `;
        }

        // Resto del código (datos mercado, gráfica, trading futures, IA) igual que antes...
        // (Para no repetir todo el código largo, el resto es idéntico a la versión anterior: actualizarDatos, crearGrafica, comprar/vender futures, simularInversion histórica, consultarIA, etc.)

        // Inicialización
        actualizarDatos();
        setInterval(actualizarDatos, 20000);
        crearGrafica();
        actualizarPosicion();
        actualizarHistorial();
    </script>
</body>
</html>
